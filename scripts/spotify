#!/usr/bin/env bash
set -eo pipefail

chmod a+x /usr/local/bin/librespot

apt-get update && apt-get install -yq libavahi-compat-libdnssd-dev

cat <<-'EOF' > /etc/systemd/system/spotify.service
[Unit]
Description=A spotify playing daemon
Documentation=https://github.com/librespot-org/librespot
Wants=sound.target network-online.target
After=sound.target network-online.target

[Service]
ExecStart=/usr/local/bin/librespot \
          --name multizone \
          --device-type avr \
          --bitrate 320 \
          --initial-volume 100 \
          --volume-ctrl fixed \
          --enable-volume-normalisation \
          --normalisation-pregain 3 \
          --normalisation-gain-type track \
          --autoplay \
          --onevent /usr/local/bin/spotify-event-handler
Restart=always
RestartSec=2

[Install]
WantedBy=default.target
EOF
systemctl enable spotify.service

# control the amp on spotify events
# list of events: https://github.com/librespot-org/librespot/blob/v0.1.6/src/player_event_handler.rs
cat <<-'EOF' > /usr/local/bin/spotify-event-handler
#!/usr/bin/env bash
set -eo pipefail

echo "$PLAYER_EVENT" > /var/log/spotify-last-event.log
case $PLAYER_EVENT in
  start|playing|change)
    /usr/local/bin/amp on
    ;;
esac
EOF
chmod a+x /usr/local/bin/spotify-event-handler

# turn off amp after 15 min of idle time
cat <<-'EOF' > /usr/local/bin/amp-sleep
#!/usr/bin/env bash
set -eo pipefail

if [ /var/log/spotify-last-event.log -nt /var/log/amp-sleep.log ] ; then
  if grep -qE '^(paused|stop)$' /var/log/spotify-last-event.log; then
    age=$(expr $(date +%s) - $(date -r /var/log/spotify-last-event.log +%s))
    if [ $age -gt 900 ] ; then
      echo "turning amp off"
      /usr/local/bin/amp off
      touch /var/log/amp-sleep.log
    fi
  fi
fi
EOF
chmod a+x /usr/local/bin/amp-sleep

cat <<-'EOF' > /etc/systemd/system/amp-sleep.service
[Unit]
Description=Check if amp should sleep
Wants=amp-sleep.timer

[Service]
Type=oneshot
ExecStart=/usr/local/bin/amp-sleep

[Install]
WantedBy=default.target
EOF

cat <<-'EOF' > /etc/systemd/system/amp-sleep.timer
[Unit]
Description=Check if amp should sleep
Requires=amp-sleep.service

[Timer]
OnCalendar=minutely

[Install]
WantedBy=timers.target
EOF

systemctl enable amp-sleep.service
systemctl enable amp-sleep.timer